{
  "id": 2487183723,
  "repo_owner": "elastic",
  "repo_name": "elasticsearch",
  "number": 127486,
  "title": "[WIP] Generate a test dependencies file to support unit tests in entitlements",
  "created_at": "2025-04-28T22:46:57",
  "updated_at": "2025-04-28T22:52:15",
  "state": "open",
  "user_login": "jdconrad",
  "diffs": "diff --git a/build-tools/src/main/java/org/elasticsearch/gradle/plugin/BasePluginBuildPlugin.java b/build-tools/src/main/java/org/elasticsearch/gradle/plugin/BasePluginBuildPlugin.java\nindex a1c003c4c315d..2a0017c81be9b 100644\n--- a/build-tools/src/main/java/org/elasticsearch/gradle/plugin/BasePluginBuildPlugin.java\n+++ b/build-tools/src/main/java/org/elasticsearch/gradle/plugin/BasePluginBuildPlugin.java\n@@ -76,7 +76,48 @@ public void apply(final Project project) {\n         var extension = project.getExtensions()\n             .create(BasePluginBuildPlugin.PLUGIN_EXTENSION_NAME, PluginPropertiesExtension.class, project);\n \n-        final var bundleTask = createBundleTasks(project, extension);\n+        final var buildProperties = project.getTasks().register(\"pluginProperties\", GeneratePluginPropertiesTask.class, task -> {\n+            task.getPluginName().set(providerFactory.provider(extension::getName));\n+            task.getPluginDescription().set(providerFactory.provider(extension::getDescription));\n+            task.getPluginVersion().set(providerFactory.provider(extension::getVersion));\n+            task.getElasticsearchVersion().set(Version.fromString(VersionProperties.getElasticsearch()).toString());\n+            var javaExtension = project.getExtensions().getByType(JavaPluginExtension.class);\n+            task.getJavaVersion().set(providerFactory.provider(() -> javaExtension.getTargetCompatibility().toString()));\n+            task.getExtendedPlugins().set(providerFactory.provider(extension::getExtendedPlugins));\n+            task.getHasNativeController().set(providerFactory.provider(extension::isHasNativeController));\n+            task.getRequiresKeystore().set(providerFactory.provider(extension::isRequiresKeystore));\n+            task.getIsLicensed().set(providerFactory.provider(extension::isLicensed));\n+\n+            var mainSourceSet = project.getExtensions().getByType(SourceSetContainer.class).getByName(SourceSet.MAIN_SOURCE_SET_NAME);\n+            FileCollection moduleInfoFile = mainSourceSet.getOutput().getAsFileTree().matching(p -> p.include(\"module-info.class\"));\n+            task.getModuleInfoFile().setFrom(moduleInfoFile);\n+        });\n+        final var testDependencies = project.getTasks()\n+            .register(\"generatePluginTestDependencies\", GeneratePluginTestDependenciesTask.class, task -> {\n+                task.getDescriptorFile().set(buildProperties.get().getOutputFile().get().getAsFile());\n+                var policy = project.getLayout().getProjectDirectory().file(\"src/main/plugin-metadata/entitlement-policy.yaml\");\n+                if (policy.getAsFile().exists()) {\n+                    task.getPolicyFile().set(policy);\n+                }\n+                task.getJarFiles()\n+                    .set(\n+                        project.getConfigurations()\n+                            .getByName(\"runtimeClasspath\")\n+                            .minus(\n+                                project.getConfigurations().getByName(CompileOnlyResolvePlugin.RESOLVEABLE_COMPILE_ONLY_CONFIGURATION_NAME)\n+                            )\n+                    );\n+                task.getClassDirectories()\n+                    .set(\n+                        project.getExtensions()\n+                            .getByType(SourceSetContainer.class)\n+                            .stream()\n+                            .flatMap(ss -> ss.getOutput().getClassesDirs().getFiles().stream())\n+                            .map(File::getAbsolutePath)\n+                            .toList()\n+                    );\n+            });\n+        final var bundleTask = createBundleTasks(buildProperties, testDependencies, project, extension);\n         project.getConfigurations().getByName(\"default\").extendsFrom(project.getConfigurations().getByName(\"runtimeClasspath\"));\n \n         // allow running ES with this plugin in the foreground of a build\n@@ -105,26 +146,14 @@ private static NamedDomainObjectContainer<ElasticsearchCluster> testClusters(Pro\n      * Adds bundle tasks which builds the dir and zip containing the plugin jars,\n      * metadata, properties, and packaging files\n      */\n-    private TaskProvider<Zip> createBundleTasks(final Project project, PluginPropertiesExtension extension) {\n+    private TaskProvider<Zip> createBundleTasks(\n+        final TaskProvider<GeneratePluginPropertiesTask> buildProperties,\n+        final TaskProvider<GeneratePluginTestDependenciesTask> testDependencies,\n+        final Project project,\n+        PluginPropertiesExtension extension\n+    ) {\n         final var pluginMetadata = project.file(\"src/main/plugin-metadata\");\n \n-        final var buildProperties = project.getTasks().register(\"pluginProperties\", GeneratePluginPropertiesTask.class, task -> {\n-            task.getPluginName().set(providerFactory.provider(extension::getName));\n-            task.getPluginDescription().set(providerFactory.provider(extension::getDescription));\n-            task.getPluginVersion().set(providerFactory.provider(extension::getVersion));\n-            task.getElasticsearchVersion().set(Version.fromString(VersionProperties.getElasticsearch()).toString());\n-            var javaExtension = project.getExtensions().getByType(JavaPluginExtension.class);\n-            task.getJavaVersion().set(providerFactory.provider(() -> javaExtension.getTargetCompatibility().toString()));\n-            task.getExtendedPlugins().set(providerFactory.provider(extension::getExtendedPlugins));\n-            task.getHasNativeController().set(providerFactory.provider(extension::isHasNativeController));\n-            task.getRequiresKeystore().set(providerFactory.provider(extension::isRequiresKeystore));\n-            task.getIsLicensed().set(providerFactory.provider(extension::isLicensed));\n-\n-            var mainSourceSet = project.getExtensions().getByType(SourceSetContainer.class).getByName(SourceSet.MAIN_SOURCE_SET_NAME);\n-            FileCollection moduleInfoFile = mainSourceSet.getOutput().getAsFileTree().matching(p -> p.include(\"module-info.class\"));\n-            task.getModuleInfoFile().setFrom(moduleInfoFile);\n-\n-        });\n         // add the plugin properties and metadata to test resources, so unit tests can\n         // know about the plugin (used by test security code to statically initialize the plugin in unit tests)\n         var testSourceSet = project.getExtensions().getByType(SourceSetContainer.class).getByName(\"test\");\n@@ -150,7 +179,7 @@ private TaskProvider<Zip> createBundleTasks(final Project project, PluginPropert\n         });\n         project.getArtifacts().add(\"pluginMetadata\", pluginMetadata);\n         // getAttributes().attribute(ArtifactTypeDefinition.ARTIFACT_TYPE_ATTRIBUTE, \"plugin-metadata\");\n-        var bundleSpec = createBundleSpec(project, pluginMetadata, buildProperties);\n+        var bundleSpec = createBundleSpec(project, pluginMetadata, buildProperties, testDependencies);\n         extension.setBundleSpec(bundleSpec);\n         // create the actual bundle task, which zips up all the files for the plugin\n         final var bundle = project.getTasks().register(\"bundlePlugin\", Zip.class, zip -> zip.with(bundleSpec));\n@@ -179,10 +208,12 @@ private TaskProvider<Zip> createBundleTasks(final Project project, PluginPropert\n     private static CopySpec createBundleSpec(\n         Project project,\n         File pluginMetadata,\n-        TaskProvider<GeneratePluginPropertiesTask> buildProperties\n+        TaskProvider<GeneratePluginPropertiesTask> buildProperties,\n+        TaskProvider<GeneratePluginTestDependenciesTask> testDependencies\n     ) {\n         var bundleSpec = project.copySpec();\n         bundleSpec.from(buildProperties);\n+        bundleSpec.from(testDependencies);\n         bundleSpec.from(pluginMetadata, copySpec -> {\n             // metadata (eg custom security policy)\n             // the codebases properties file is only for tests and not needed in production\ndiff --git a/build-tools/src/main/java/org/elasticsearch/gradle/plugin/GeneratePluginTestDependenciesTask.java b/build-tools/src/main/java/org/elasticsearch/gradle/plugin/GeneratePluginTestDependenciesTask.java\nnew file mode 100644\nindex 0000000000000..d71570938ddd1\n--- /dev/null\n+++ b/build-tools/src/main/java/org/elasticsearch/gradle/plugin/GeneratePluginTestDependenciesTask.java\n@@ -0,0 +1,93 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the \"Elastic License\n+ * 2.0\", the \"GNU Affero General Public License v3.0 only\", and the \"Server Side\n+ * Public License v 1\"; you may not use this file except in compliance with, at\n+ * your election, the \"Elastic License 2.0\", the \"GNU Affero General Public\n+ * License v3.0 only\", or the \"Server Side Public License, v 1\".\n+ */\n+\n+package org.elasticsearch.gradle.plugin;\n+\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.file.FileCollection;\n+import org.gradle.api.file.RegularFileProperty;\n+import org.gradle.api.provider.ListProperty;\n+import org.gradle.api.provider.Property;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFile;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.Optional;\n+import org.gradle.api.tasks.OutputFile;\n+import org.gradle.api.tasks.TaskAction;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+public abstract class GeneratePluginTestDependenciesTask extends DefaultTask {\n+\n+    public static final String DESCRIPTION = \"generates plugin test dependencies file\";\n+    public static final String PROPERTIES_FILENAME = \"plugin-test-dependencies.properties\";\n+\n+    public GeneratePluginTestDependenciesTask() {\n+        setDescription(DESCRIPTION);\n+    }\n+\n+    @InputFile\n+    public abstract RegularFileProperty getDescriptorFile();\n+\n+    @InputFile\n+    @Optional\n+    public abstract RegularFileProperty getPolicyFile();\n+\n+    @InputFiles\n+    public abstract Property<FileCollection> getJarFiles();\n+\n+    @Input\n+    public abstract ListProperty<String> getClassDirectories();\n+\n+    @OutputFile\n+    public abstract RegularFileProperty getOutputFile();\n+\n+    @TaskAction\n+    public void generatePropertiesFile() throws IOException {\n+        Path outputFile = getOutputFile().get().getAsFile().toPath();\n+        Files.createDirectories(outputFile.getParent());\n+        try (var writer = Files.newBufferedWriter(outputFile, StandardCharsets.UTF_8)) {\n+            writer.write(\"descriptor=\");\n+            writer.write(getDescriptorFile().getAsFile().get().getAbsolutePath());\n+            writer.write(\"\\n\");\n+\n+            if (getPolicyFile().isPresent()) {\n+                writer.write(\"policy=\");\n+                writer.write(getPolicyFile().getAsFile().get().getAbsolutePath());\n+                writer.write(\"\\n\");\n+            }\n+\n+            if (getJarFiles().get().isEmpty() == false) {\n+                writer.write(\"jars=\");\n+                StringBuilder sb = new StringBuilder();\n+                for (File jar : getJarFiles().get()) {\n+                    sb.append(jar.getAbsolutePath());\n+                    sb.append(\":\");\n+                }\n+                writer.write(sb.substring(0, sb.length() - 1));\n+                writer.write(\"\\n\");\n+            }\n+\n+            if (getClassDirectories().get().isEmpty() == false) {\n+                writer.write(\"directories=\");\n+                StringBuilder sb = new StringBuilder();\n+                for (String sd : getClassDirectories().get()) {\n+                    sb.append(sd);\n+                    sb.append(\":\");\n+                }\n+                writer.write(sb.substring(0, sb.length() - 1));\n+                writer.write(\"\\n\");\n+            }\n+        }\n+    }\n+}\ndiff --git a/build-tools/src/main/java/org/elasticsearch/gradle/plugin/PluginBuildPlugin.java b/build-tools/src/main/java/org/elasticsearch/gradle/plugin/PluginBuildPlugin.java\nindex d5fec104c063e..5213fd0ed727c 100644\n--- a/build-tools/src/main/java/org/elasticsearch/gradle/plugin/PluginBuildPlugin.java\n+++ b/build-tools/src/main/java/org/elasticsearch/gradle/plugin/PluginBuildPlugin.java\n@@ -51,6 +51,12 @@ public void apply(final Project project) {\n             task.getOutputFile().set(file);\n         });\n \n+        project.getTasks().withType(GeneratePluginTestDependenciesTask.class).named(\"generatePluginTestDependencies\").configure(task -> {\n+            Provider<RegularFile> file = project.getLayout()\n+                .getBuildDirectory()\n+                .file(\"generated-test-dependencies/\" + GeneratePluginTestDependenciesTask.PROPERTIES_FILENAME);\n+            task.getOutputFile().set(file);\n+        });\n     }\n \n }\n",
  "files_changed": 3,
  "additions": 151,
  "deletions": 21,
  "commit_count": 3,
  "mergeable_state": "",
  "base_commit_sha": "d65f34d173bf419df55cf355639be32c929992a5",
  "base_commit_link": "https://github.com/elastic/elasticsearch/commit/d65f34d173bf419df55cf355639be32c929992a5",
  "last_processed_time": "2025-04-29T01:29:32",
  "comments": [
    {
      "id": 2836943674,
      "pr_id": 2487183723,
      "body": "Pinging @elastic/es-core-infra (Team:Core/Infra)",
      "created_at": "2025-04-28T22:47:21",
      "user_login": "elasticsearchmachine",
      "path": "",
      "position": 0
    }
  ],
  "github_reviews": [],
  "patches": [
    {
      "id": 1928,
      "pr_id": 2487183723,
      "path": "build-tools/src/main/java/org/elasticsearch/gradle/plugin/BasePluginBuildPlugin.java",
      "patch": "@@ -76,7 +76,48 @@ public void apply(final Project project) {\n         var extension = project.getExtensions()\n             .create(BasePluginBuildPlugin.PLUGIN_EXTENSION_NAME, PluginPropertiesExtension.class, project);\n \n-        final var bundleTask = createBundleTasks(project, extension);\n+        final var buildProperties = project.getTasks().register(\"pluginProperties\", GeneratePluginPropertiesTask.class, task -> {\n+            task.getPluginName().set(providerFactory.provider(extension::getName));\n+            task.getPluginDescription().set(providerFactory.provider(extension::getDescription));\n+            task.getPluginVersion().set(providerFactory.provider(extension::getVersion));\n+            task.getElasticsearchVersion().set(Version.fromString(VersionProperties.getElasticsearch()).toString());\n+            var javaExtension = project.getExtensions().getByType(JavaPluginExtension.class);\n+            task.getJavaVersion().set(providerFactory.provider(() -> javaExtension.getTargetCompatibility().toString()));\n+            task.getExtendedPlugins().set(providerFactory.provider(extension::getExtendedPlugins));\n+            task.getHasNativeController().set(providerFactory.provider(extension::isHasNativeController));\n+            task.getRequiresKeystore().set(providerFactory.provider(extension::isRequiresKeystore));\n+            task.getIsLicensed().set(providerFactory.provider(extension::isLicensed));\n+\n+            var mainSourceSet = project.getExtensions().getByType(SourceSetContainer.class).getByName(SourceSet.MAIN_SOURCE_SET_NAME);\n+            FileCollection moduleInfoFile = mainSourceSet.getOutput().getAsFileTree().matching(p -> p.include(\"module-info.class\"));\n+            task.getModuleInfoFile().setFrom(moduleInfoFile);\n+        });\n+        final var testDependencies = project.getTasks()\n+            .register(\"generatePluginTestDependencies\", GeneratePluginTestDependenciesTask.class, task -> {\n+                task.getDescriptorFile().set(buildProperties.get().getOutputFile().get().getAsFile());\n+                var policy = project.getLayout().getProjectDirectory().file(\"src/main/plugin-metadata/entitlement-policy.yaml\");\n+                if (policy.getAsFile().exists()) {\n+                    task.getPolicyFile().set(policy);\n+                }\n+                task.getJarFiles()\n+                    .set(\n+                        project.getConfigurations()\n+                            .getByName(\"runtimeClasspath\")\n+                            .minus(\n+                                project.getConfigurations().getByName(CompileOnlyResolvePlugin.RESOLVEABLE_COMPILE_ONLY_CONFIGURATION_NAME)\n+                            )\n+                    );\n+                task.getClassDirectories()\n+                    .set(\n+                        project.getExtensions()\n+                            .getByType(SourceSetContainer.class)\n+                            .stream()\n+                            .flatMap(ss -> ss.getOutput().getClassesDirs().getFiles().stream())\n+                            .map(File::getAbsolutePath)\n+                            .toList()\n+                    );\n+            });\n+        final var bundleTask = createBundleTasks(buildProperties, testDependencies, project, extension);\n         project.getConfigurations().getByName(\"default\").extendsFrom(project.getConfigurations().getByName(\"runtimeClasspath\"));\n \n         // allow running ES with this plugin in the foreground of a build\n@@ -105,26 +146,14 @@ private static NamedDomainObjectContainer<ElasticsearchCluster> testClusters(Pro\n      * Adds bundle tasks which builds the dir and zip containing the plugin jars,\n      * metadata, properties, and packaging files\n      */\n-    private TaskProvider<Zip> createBundleTasks(final Project project, PluginPropertiesExtension extension) {\n+    private TaskProvider<Zip> createBundleTasks(\n+        final TaskProvider<GeneratePluginPropertiesTask> buildProperties,\n+        final TaskProvider<GeneratePluginTestDependenciesTask> testDependencies,\n+        final Project project,\n+        PluginPropertiesExtension extension\n+    ) {\n         final var pluginMetadata = project.file(\"src/main/plugin-metadata\");\n \n-        final var buildProperties = project.getTasks().register(\"pluginProperties\", GeneratePluginPropertiesTask.class, task -> {\n-            task.getPluginName().set(providerFactory.provider(extension::getName));\n-            task.getPluginDescription().set(providerFactory.provider(extension::getDescription));\n-            task.getPluginVersion().set(providerFactory.provider(extension::getVersion));\n-            task.getElasticsearchVersion().set(Version.fromString(VersionProperties.getElasticsearch()).toString());\n-            var javaExtension = project.getExtensions().getByType(JavaPluginExtension.class);\n-            task.getJavaVersion().set(providerFactory.provider(() -> javaExtension.getTargetCompatibility().toString()));\n-            task.getExtendedPlugins().set(providerFactory.provider(extension::getExtendedPlugins));\n-            task.getHasNativeController().set(providerFactory.provider(extension::isHasNativeController));\n-            task.getRequiresKeystore().set(providerFactory.provider(extension::isRequiresKeystore));\n-            task.getIsLicensed().set(providerFactory.provider(extension::isLicensed));\n-\n-            var mainSourceSet = project.getExtensions().getByType(SourceSetContainer.class).getByName(SourceSet.MAIN_SOURCE_SET_NAME);\n-            FileCollection moduleInfoFile = mainSourceSet.getOutput().getAsFileTree().matching(p -> p.include(\"module-info.class\"));\n-            task.getModuleInfoFile().setFrom(moduleInfoFile);\n-\n-        });\n         // add the plugin properties and metadata to test resources, so unit tests can\n         // know about the plugin (used by test security code to statically initialize the plugin in unit tests)\n         var testSourceSet = project.getExtensions().getByType(SourceSetContainer.class).getByName(\"test\");\n@@ -150,7 +179,7 @@ private TaskProvider<Zip> createBundleTasks(final Project project, PluginPropert\n         });\n         project.getArtifacts().add(\"pluginMetadata\", pluginMetadata);\n         // getAttributes().attribute(ArtifactTypeDefinition.ARTIFACT_TYPE_ATTRIBUTE, \"plugin-metadata\");\n-        var bundleSpec = createBundleSpec(project, pluginMetadata, buildProperties);\n+        var bundleSpec = createBundleSpec(project, pluginMetadata, buildProperties, testDependencies);\n         extension.setBundleSpec(bundleSpec);\n         // create the actual bundle task, which zips up all the files for the plugin\n         final var bundle = project.getTasks().register(\"bundlePlugin\", Zip.class, zip -> zip.with(bundleSpec));\n@@ -179,10 +208,12 @@ private TaskProvider<Zip> createBundleTasks(final Project project, PluginPropert\n     private static CopySpec createBundleSpec(\n         Project project,\n         File pluginMetadata,\n-        TaskProvider<GeneratePluginPropertiesTask> buildProperties\n+        TaskProvider<GeneratePluginPropertiesTask> buildProperties,\n+        TaskProvider<GeneratePluginTestDependenciesTask> testDependencies\n     ) {\n         var bundleSpec = project.copySpec();\n         bundleSpec.from(buildProperties);\n+        bundleSpec.from(testDependencies);\n         bundleSpec.from(pluginMetadata, copySpec -> {\n             // metadata (eg custom security policy)\n             // the codebases properties file is only for tests and not needed in production",
      "filename": "build-tools/src/main/java/org/elasticsearch/gradle/plugin/BasePluginBuildPlugin.java",
      "status": "modified",
      "changes": 73,
      "additions": 52,
      "deletions": 21
    },
    {
      "id": 1929,
      "pr_id": 2487183723,
      "path": "build-tools/src/main/java/org/elasticsearch/gradle/plugin/GeneratePluginTestDependenciesTask.java",
      "patch": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the \"Elastic License\n+ * 2.0\", the \"GNU Affero General Public License v3.0 only\", and the \"Server Side\n+ * Public License v 1\"; you may not use this file except in compliance with, at\n+ * your election, the \"Elastic License 2.0\", the \"GNU Affero General Public\n+ * License v3.0 only\", or the \"Server Side Public License, v 1\".\n+ */\n+\n+package org.elasticsearch.gradle.plugin;\n+\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.file.FileCollection;\n+import org.gradle.api.file.RegularFileProperty;\n+import org.gradle.api.provider.ListProperty;\n+import org.gradle.api.provider.Property;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFile;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.Optional;\n+import org.gradle.api.tasks.OutputFile;\n+import org.gradle.api.tasks.TaskAction;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+public abstract class GeneratePluginTestDependenciesTask extends DefaultTask {\n+\n+    public static final String DESCRIPTION = \"generates plugin test dependencies file\";\n+    public static final String PROPERTIES_FILENAME = \"plugin-test-dependencies.properties\";\n+\n+    public GeneratePluginTestDependenciesTask() {\n+        setDescription(DESCRIPTION);\n+    }\n+\n+    @InputFile\n+    public abstract RegularFileProperty getDescriptorFile();\n+\n+    @InputFile\n+    @Optional\n+    public abstract RegularFileProperty getPolicyFile();\n+\n+    @InputFiles\n+    public abstract Property<FileCollection> getJarFiles();\n+\n+    @Input\n+    public abstract ListProperty<String> getClassDirectories();\n+\n+    @OutputFile\n+    public abstract RegularFileProperty getOutputFile();\n+\n+    @TaskAction\n+    public void generatePropertiesFile() throws IOException {\n+        Path outputFile = getOutputFile().get().getAsFile().toPath();\n+        Files.createDirectories(outputFile.getParent());\n+        try (var writer = Files.newBufferedWriter(outputFile, StandardCharsets.UTF_8)) {\n+            writer.write(\"descriptor=\");\n+            writer.write(getDescriptorFile().getAsFile().get().getAbsolutePath());\n+            writer.write(\"\\n\");\n+\n+            if (getPolicyFile().isPresent()) {\n+                writer.write(\"policy=\");\n+                writer.write(getPolicyFile().getAsFile().get().getAbsolutePath());\n+                writer.write(\"\\n\");\n+            }\n+\n+            if (getJarFiles().get().isEmpty() == false) {\n+                writer.write(\"jars=\");\n+                StringBuilder sb = new StringBuilder();\n+                for (File jar : getJarFiles().get()) {\n+                    sb.append(jar.getAbsolutePath());\n+                    sb.append(\":\");\n+                }\n+                writer.write(sb.substring(0, sb.length() - 1));\n+                writer.write(\"\\n\");\n+            }\n+\n+            if (getClassDirectories().get().isEmpty() == false) {\n+                writer.write(\"directories=\");\n+                StringBuilder sb = new StringBuilder();\n+                for (String sd : getClassDirectories().get()) {\n+                    sb.append(sd);\n+                    sb.append(\":\");\n+                }\n+                writer.write(sb.substring(0, sb.length() - 1));\n+                writer.write(\"\\n\");\n+            }\n+        }\n+    }\n+}",
      "filename": "build-tools/src/main/java/org/elasticsearch/gradle/plugin/GeneratePluginTestDependenciesTask.java",
      "status": "added",
      "changes": 93,
      "additions": 93,
      "deletions": 0
    },
    {
      "id": 1930,
      "pr_id": 2487183723,
      "path": "build-tools/src/main/java/org/elasticsearch/gradle/plugin/PluginBuildPlugin.java",
      "patch": "@@ -51,6 +51,12 @@ public void apply(final Project project) {\n             task.getOutputFile().set(file);\n         });\n \n+        project.getTasks().withType(GeneratePluginTestDependenciesTask.class).named(\"generatePluginTestDependencies\").configure(task -> {\n+            Provider<RegularFile> file = project.getLayout()\n+                .getBuildDirectory()\n+                .file(\"generated-test-dependencies/\" + GeneratePluginTestDependenciesTask.PROPERTIES_FILENAME);\n+            task.getOutputFile().set(file);\n+        });\n     }\n \n }",
      "filename": "build-tools/src/main/java/org/elasticsearch/gradle/plugin/PluginBuildPlugin.java",
      "status": "modified",
      "changes": 6,
      "additions": 6,
      "deletions": 0
    }
  ],
  "ai_reviews": [
    {
      "id": 16,
      "pr_id": 2487183723,
      "summary": "This pull request (PR) aims to enhance the unit testing capabilities for the entitlements module by generating a test dependencies file. This is crucial for ensuring that all necessary dependencies are included when running unit tests, thereby improving the reliability and maintainability of the codebase.\n\nSignificant modifications include the addition of a new class, `GeneratePluginTestDependenciesTask.java`, which contains 93 lines of code dedicated to the logic for generating the test dependencies file. Additionally, the `BasePluginBuildPlugin.java` file has been modified with 52 additions and 21 deletions, likely to integrate the new task into the existing build process. The `PluginBuildPlugin.java` file has also been updated with 6 additions, suggesting further enhancements to the plugin's build configuration.\n\nPotential concerns include ensuring that the new task integrates seamlessly with existing build processes and does not introduce any regressions. It would be beneficial to include unit tests for the new functionality to validate its correctness and to document the usage of the generated dependencies file for future developers. Additionally, reviewing the impact of the deletions in `BasePluginBuildPlugin.java` is essential to confirm that no critical functionality has been removed. Overall, this PR represents a positive step towards improving testing practices within the project.",
      "full_review": "# AI Review \ud83e\udd16\n\n## Summary\nThis pull request (PR) aims to enhance the unit testing capabilities for the entitlements module by generating a test dependencies file. This is crucial for ensuring that all necessary dependencies are included when running unit tests, thereby improving the reliability and maintainability of the codebase.\n\nSignificant modifications include the addition of a new class, `GeneratePluginTestDependenciesTask.java`, which contains 93 lines of code dedicated to the logic for generating the test dependencies file. Additionally, the `BasePluginBuildPlugin.java` file has been modified with 52 additions and 21 deletions, likely to integrate the new task into the existing build process. The `PluginBuildPlugin.java` file has also been updated with 6 additions, suggesting further enhancements to the plugin's build configuration.\n\nPotential concerns include ensuring that the new task integrates seamlessly with existing build processes and does not introduce any regressions. It would be beneficial to include unit tests for the new functionality to validate its correctness and to document the usage of the generated dependencies file for future developers. Additionally, reviewing the impact of the deletions in `BasePluginBuildPlugin.java` is essential to confirm that no critical functionality has been removed. Overall, this PR represents a positive step towards improving testing practices within the project.\n\n## Detailed Review\n\n### build-tools/src/main/java/org/elasticsearch/gradle/plugin/BasePluginBuildPlugin.java\nOverall, the code diff appears to be a significant refactor that enhances the task registration and dependency management for the plugin build process. However, there are a few areas that could be improved or warrant further consideration.\n\n### Specific Issues:\n\n1. **Line 76-77**: The `buildProperties` task is registered but not immediately executed. Ensure that the task dependencies are correctly set up so that any tasks relying on `buildProperties` will not execute until it has completed. This is crucial for maintaining the correct order of task execution.\n\n2. **Line 146**: The `createBundleTasks` method now takes additional parameters (`testDependencies`). Ensure that all usages of this method throughout the codebase are updated accordingly. If there are any calls to this method that do not provide the new parameters, it will lead to compilation errors.\n\n3. **Line 179**: The `bundleSpec.from(testDependencies);` line assumes that `testDependencies` can be directly added to the copy spec. Ensure that `testDependencies` is a valid source for the copy spec. If it is not a file collection or does not provide the expected output, this could lead to runtime errors.\n\n4. **Line 105**: The comment regarding the purpose of the `createBundleTasks` method could be expanded to clarify what specific files or metadata are included in the bundle. This would improve maintainability and understanding for future developers.\n\n5. **Line 146-179**: The method `createBundleSpec` now takes an additional parameter. Ensure that the logic inside this method correctly handles the new input. If `testDependencies` is not properly validated or handled, it could lead to unexpected behavior.\n\n### Performance Issues:\n- The use of `flatMap` and `stream()` in the `testDependencies` task registration could be optimized. If the number of source sets is large, this could lead to performance overhead. Consider caching the results or using a more efficient data structure if performance becomes an issue.\n\n### Security Vulnerabilities:\n- Ensure that any files being included from `testDependencies` do not expose sensitive information or allow for unintended access. Validate the contents of these files if they are user-generated or configurable.\n\n### Code Style and Best Practices:\n- Consider using more descriptive variable names instead of `var` for better readability, especially in complex expressions. For example, `buildProperties` and `testDependencies` are clear, but in other contexts, explicit types can enhance understanding.\n\n### Potential Edge Cases:\n- If the `policyFile` does not exist, the task will not set it, which may lead to issues later if other tasks expect this file to be present. Consider adding a fallback or a warning log to inform the user that the policy file was not found.\n\nIn summary, while the changes are generally positive and enhance the functionality, attention should be paid to task dependencies, input validation, and performance considerations. Addressing these points will help ensure robustness and maintainability in the codebase.\n### build-tools/src/main/java/org/elasticsearch/gradle/plugin/GeneratePluginTestDependenciesTask.java\nOverall, the code looks well-structured and follows good practices for a Gradle task. However, there are a few areas that could be improved for better performance, error handling, and code style. Here are the specific points:\n\n1. **Error Handling**:\n   - **Line 56-57**: The code does not handle potential `IOException` that may occur when writing to the file. It would be beneficial to add error handling to provide more context if an error occurs during file operations.\n\n2. **Performance**:\n   - **Line 56-57**: Instead of using `StringBuilder` and appending strings in a loop, consider using `String.join()` for better readability and potentially improved performance. For example:\n     ```java\n     writer.write(\"jars=\" + String.join(\":\", getJarFiles().get().stream().map(File::getAbsolutePath).toArray(String[]::new)) + \"\\n\");\n     ```\n\n3. **Code Style**:\n   - **Line 54**: The check for `isEmpty()` can be simplified to `!getJarFiles().get().isEmpty()`. While this is a minor point, it can improve readability.\n   - **Line 54-55**: The same applies to the check for class directories. Consider using `!getClassDirectories().get().isEmpty()` for consistency.\n\n4. **Potential Edge Cases**:\n   - **Line 56-57**: If `getJarFiles()` or `getClassDirectories()` returns a collection with only one element, the current implementation will still append a colon at the end. This could lead to an unexpected format in the output file. Ensure that the code handles single-element cases correctly.\n   - **Line 56-57**: If the `getDescriptorFile()` or `getPolicyFile()` returns a file that does not exist, it may lead to a `FileNotFoundException`. Consider validating the existence of these files before attempting to write their paths.\n\n5. **Documentation**:\n   - Consider adding JavaDoc comments for the class and its methods to improve maintainability and provide context for future developers.\n\nBy addressing these points, the code can be made more robust and maintainable.\n### build-tools/src/main/java/org/elasticsearch/gradle/plugin/PluginBuildPlugin.java\nOverall, the code diff appears to be a straightforward addition of a configuration for a Gradle task. However, there are a few points worth noting:\n\n1. **Bugs or Logical Errors**:\n   - There are no apparent bugs or logical errors in the new code. The configuration for the `generatePluginTestDependencies` task seems to be correctly implemented.\n\n2. **Performance Issues**:\n   - There are no performance issues identified in this diff. The use of `Provider<RegularFile>` is appropriate for lazy evaluation in Gradle.\n\n3. **Security Vulnerabilities**:\n   - No security vulnerabilities are evident in this code. The changes do not introduce any user input or external dependencies that could lead to security issues.\n\n4. **Code Style and Best Practices**:\n   - The code follows standard Java conventions and Gradle DSL practices. However, consider adding a comment above the new task configuration to explain its purpose, especially if this is part of a larger codebase. This can improve maintainability.\n\n5. **Potential Edge Cases**:\n   - Ensure that the directory `generated-test-dependencies` is created before the task runs. If the directory does not exist, it could lead to issues when trying to set the output file. You might want to add a check or ensure that the task creates the directory if it doesn't exist.\n\nIn summary, while the code looks good overall, adding a comment for clarity and ensuring the output directory exists would enhance the code's maintainability and robustness.\n\n**Specific Issues**:\n- **Line 52-57**: Consider adding a comment to explain the purpose of the new task configuration.\n- **Line 56**: Ensure the output directory exists before setting the output file.\n\nOverall, the changes are well-implemented, but a couple of minor improvements could be made.\n\n\n---\n*This review was automatically generated by an AI assistant.*",
      "created_at": "2025-04-29T01:29:32",
      "file_reviews": [
        {
          "id": 140,
          "review_id": 16,
          "pr_id": 2487183723,
          "filename": "build-tools/src/main/java/org/elasticsearch/gradle/plugin/BasePluginBuildPlugin.java",
          "content": "Overall, the code diff appears to be a significant refactor that enhances the task registration and dependency management for the plugin build process. However, there are a few areas that could be improved or warrant further consideration.\n\n### Specific Issues:\n\n1. **Line 76-77**: The `buildProperties` task is registered but not immediately executed. Ensure that the task dependencies are correctly set up so that any tasks relying on `buildProperties` will not execute until it has completed. This is crucial for maintaining the correct order of task execution.\n\n2. **Line 146**: The `createBundleTasks` method now takes additional parameters (`testDependencies`). Ensure that all usages of this method throughout the codebase are updated accordingly. If there are any calls to this method that do not provide the new parameters, it will lead to compilation errors.\n\n3. **Line 179**: The `bundleSpec.from(testDependencies);` line assumes that `testDependencies` can be directly added to the copy spec. Ensure that `testDependencies` is a valid source for the copy spec. If it is not a file collection or does not provide the expected output, this could lead to runtime errors.\n\n4. **Line 105**: The comment regarding the purpose of the `createBundleTasks` method could be expanded to clarify what specific files or metadata are included in the bundle. This would improve maintainability and understanding for future developers.\n\n5. **Line 146-179**: The method `createBundleSpec` now takes an additional parameter. Ensure that the logic inside this method correctly handles the new input. If `testDependencies` is not properly validated or handled, it could lead to unexpected behavior.\n\n### Performance Issues:\n- The use of `flatMap` and `stream()` in the `testDependencies` task registration could be optimized. If the number of source sets is large, this could lead to performance overhead. Consider caching the results or using a more efficient data structure if performance becomes an issue.\n\n### Security Vulnerabilities:\n- Ensure that any files being included from `testDependencies` do not expose sensitive information or allow for unintended access. Validate the contents of these files if they are user-generated or configurable.\n\n### Code Style and Best Practices:\n- Consider using more descriptive variable names instead of `var` for better readability, especially in complex expressions. For example, `buildProperties` and `testDependencies` are clear, but in other contexts, explicit types can enhance understanding.\n\n### Potential Edge Cases:\n- If the `policyFile` does not exist, the task will not set it, which may lead to issues later if other tasks expect this file to be present. Consider adding a fallback or a warning log to inform the user that the policy file was not found.\n\nIn summary, while the changes are generally positive and enhance the functionality, attention should be paid to task dependencies, input validation, and performance considerations. Addressing these points will help ensure robustness and maintainability in the codebase.",
          "created_at": "2025-04-29T01:29:32"
        },
        {
          "id": 141,
          "review_id": 16,
          "pr_id": 2487183723,
          "filename": "build-tools/src/main/java/org/elasticsearch/gradle/plugin/GeneratePluginTestDependenciesTask.java",
          "content": "Overall, the code looks well-structured and follows good practices for a Gradle task. However, there are a few areas that could be improved for better performance, error handling, and code style. Here are the specific points:\n\n1. **Error Handling**:\n   - **Line 56-57**: The code does not handle potential `IOException` that may occur when writing to the file. It would be beneficial to add error handling to provide more context if an error occurs during file operations.\n\n2. **Performance**:\n   - **Line 56-57**: Instead of using `StringBuilder` and appending strings in a loop, consider using `String.join()` for better readability and potentially improved performance. For example:\n     ```java\n     writer.write(\"jars=\" + String.join(\":\", getJarFiles().get().stream().map(File::getAbsolutePath).toArray(String[]::new)) + \"\\n\");\n     ```\n\n3. **Code Style**:\n   - **Line 54**: The check for `isEmpty()` can be simplified to `!getJarFiles().get().isEmpty()`. While this is a minor point, it can improve readability.\n   - **Line 54-55**: The same applies to the check for class directories. Consider using `!getClassDirectories().get().isEmpty()` for consistency.\n\n4. **Potential Edge Cases**:\n   - **Line 56-57**: If `getJarFiles()` or `getClassDirectories()` returns a collection with only one element, the current implementation will still append a colon at the end. This could lead to an unexpected format in the output file. Ensure that the code handles single-element cases correctly.\n   - **Line 56-57**: If the `getDescriptorFile()` or `getPolicyFile()` returns a file that does not exist, it may lead to a `FileNotFoundException`. Consider validating the existence of these files before attempting to write their paths.\n\n5. **Documentation**:\n   - Consider adding JavaDoc comments for the class and its methods to improve maintainability and provide context for future developers.\n\nBy addressing these points, the code can be made more robust and maintainable.",
          "created_at": "2025-04-29T01:29:32"
        },
        {
          "id": 142,
          "review_id": 16,
          "pr_id": 2487183723,
          "filename": "build-tools/src/main/java/org/elasticsearch/gradle/plugin/PluginBuildPlugin.java",
          "content": "Overall, the code diff appears to be a straightforward addition of a configuration for a Gradle task. However, there are a few points worth noting:\n\n1. **Bugs or Logical Errors**:\n   - There are no apparent bugs or logical errors in the new code. The configuration for the `generatePluginTestDependencies` task seems to be correctly implemented.\n\n2. **Performance Issues**:\n   - There are no performance issues identified in this diff. The use of `Provider<RegularFile>` is appropriate for lazy evaluation in Gradle.\n\n3. **Security Vulnerabilities**:\n   - No security vulnerabilities are evident in this code. The changes do not introduce any user input or external dependencies that could lead to security issues.\n\n4. **Code Style and Best Practices**:\n   - The code follows standard Java conventions and Gradle DSL practices. However, consider adding a comment above the new task configuration to explain its purpose, especially if this is part of a larger codebase. This can improve maintainability.\n\n5. **Potential Edge Cases**:\n   - Ensure that the directory `generated-test-dependencies` is created before the task runs. If the directory does not exist, it could lead to issues when trying to set the output file. You might want to add a check or ensure that the task creates the directory if it doesn't exist.\n\nIn summary, while the code looks good overall, adding a comment for clarity and ensuring the output directory exists would enhance the code's maintainability and robustness.\n\n**Specific Issues**:\n- **Line 52-57**: Consider adding a comment to explain the purpose of the new task configuration.\n- **Line 56**: Ensure the output directory exists before setting the output file.\n\nOverall, the changes are well-implemented, but a couple of minor improvements could be made.",
          "created_at": "2025-04-29T01:29:32"
        }
      ]
    }
  ]
}